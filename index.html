<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crêpe Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .floating {
            animation: float 3s ease-in-out infinite;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        .slide-in {
            animation: slideIn 0.5s forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .bg-cream {
            background-color: #FFF8E1;
        }
        .bg-light-yellow {
            background-color: #FFF9C4;
        }
        .transition-all {
            transition: all 0.3s ease;
        }
        .max-h-0 {
            max-height: 0;
            overflow: hidden;
        }
        .max-h-screen {
            max-height: 100vh;
        }
    </style>
</head>
<body class="bg-cream min-h-screen font-sans">
    <!-- Firebase Config -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDx2Z3Hj7Q4Q4Q4Q4Q4Q4Q4Q4Q4Q4Q4Q4",
            authDomain: "crepe-management.firebaseapp.com",
            databaseURL: "https://crepe-management-default-rtdb.firebaseio.com",
            projectId: "crepe-management",
            storageBucket: "crepe-management.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
    </script>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-amber-900">Crêpe Management System</h1>
            <div class="relative">
                <button id="menuToggle" class="p-2 rounded-full hover:bg-amber-200 transition-all">
                    <i class="fas fa-ellipsis-v text-amber-800 text-xl"></i>
                </button>
                <div id="authMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
                    <button onclick="showLogin('customer')" class="block w-full text-left px-4 py-2 text-sm text-amber-800 hover:bg-amber-100">Kundenbereich</button>
                    <button onclick="showLogin('waiter')" class="block w-full text-left px-4 py-2 text-sm text-amber-800 hover:bg-amber-100">Kellner Login</button>
                    <button onclick="showLogin('maker')" class="block w-full text-left px-4 py-2 text-sm text-amber-800 hover:bg-amber-100">Hersteller Login</button>
                    <button onclick="showLogin('owner')" class="block w-full text-left px-4 py-2 text-sm text-amber-800 hover:bg-amber-100">Owner Login</button>
                    <button onclick="showLogin('admin')" class="block w-full text-left px-4 py-2 text-sm text-amber-800 hover:bg-amber-100">Admin Login</button>
                </div>
            </div>
        </header>

        <!-- Customer Section (Default View) -->
        <section id="customerSection" class="bg-white rounded-lg shadow-md p-6 mb-8 transition-all">
            <div class="text-center mb-8">
                <div class="floating inline-block mb-4">
                    <img src="https://cdn-icons-png.flaticon.com/512/2965/2965574.png" alt="Crêpe" class="w-24 h-24">
                </div>
                <h2 class="text-2xl font-bold text-amber-900 mb-2">Willkommen beim Crêpe Stand!</h2>
                <p class="text-amber-800">Überprüfen Sie den Status Ihrer Bestellung</p>
            </div>
            
            <div class="max-w-md mx-auto">
                <div class="mb-4">
                    <label for="orderNumber" class="block text-amber-800 mb-2">Ihre Bestellnummer:</label>
                    <input type="text" id="orderNumber" class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <button onclick="checkOrderStatus()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-lg transition-all pulse">
                    Status prüfen <i class="fas fa-search ml-2"></i>
                </button>
            </div>
            
            <div id="orderStatus" class="hidden mt-8 p-4 bg-amber-50 rounded-lg">
                <h3 class="text-xl font-bold text-amber-900 mb-4">Bestellstatus</h3>
                <div class="flex justify-between mb-2">
                    <span class="text-amber-800">Bestellnummer:</span>
                    <span id="statusOrderNumber" class="font-bold">#12345</span>
                </div>
                <div class="flex justify-between mb-2">
                    <span class="text-amber-800">Bestellung:</span>
                    <span id="statusOrderItems" class="font-bold">Crêpe mit Nutella</span>
                </div>
                <div class="flex justify-between mb-2">
                    <span class="text-amber-800">Position in Warteschlange:</span>
                    <span id="statusQueuePosition" class="font-bold">3</span>
                </div>
                <div class="flex justify-between mb-4">
                    <span class="text-amber-800">Geschätzte Wartezeit:</span>
                    <span id="statusWaitTime" class="font-bold">15 Minuten</span>
                </div>
                <div id="readyAlert" class="hidden bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4">
                    <p class="font-bold">Ihre Bestellung ist fertig!</p>
                    <p>Bitte kommen Sie zum Crêpe Stand.</p>
                </div>
                <div id="almostReadyAlert" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4">
                    <p class="font-bold">Ihre Bestellung wird gleich fertig!</p>
                    <p>Bitte machen Sie sich in 5 Minuten auf den Weg zum Crêpe Stand.</p>
                </div>
            </div>
        </section>

        <!-- Login Modals -->
        <div id="loginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="loginTitle" class="text-xl font-bold text-amber-900">Login</h3>
                    <button onclick="hideLogin()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <label for="loginEmail" class="block text-amber-800 mb-2">E-Mail:</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="mb-6">
                    <label for="loginPassword" class="block text-amber-800 mb-2">Passwort:</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <button id="loginButton" onclick="login()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                    Einloggen
                </button>
                <div id="makerStationSelection" class="hidden mt-4">
                    <p class="text-amber-800 mb-2">Wählen Sie Ihre Station:</p>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="selectMakerStation(1)" class="bg-amber-200 hover:bg-amber-300 text-amber-800 py-2 rounded-lg transition-all">Station 1</button>
                        <button onclick="selectMakerStation(2)" class="bg-amber-200 hover:bg-amber-300 text-amber-800 py-2 rounded-lg transition-all">Station 2</button>
                        <button onclick="selectMakerStation(3)" class="bg-amber-200 hover:bg-amber-300 text-amber-800 py-2 rounded-lg transition-all">Station 3</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Waiter Dashboard -->
        <section id="waiterSection" class="hidden bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-amber-900">Kellner Dashboard</h2>
                <button onclick="logout()" class="text-amber-800 hover:text-amber-600">
                    <i class="fas fa-sign-out-alt mr-1"></i> Ausloggen
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-amber-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-amber-800 mb-4">Vordefinierte Crêpes</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button onclick="addToOrder('Nutella Crêpe', 3.50)" class="bg-white hover:bg-amber-100 border border-amber-200 text-amber-800 py-2 px-4 rounded-lg transition-all flex justify-between items-center">
                            <span>Nutella Crêpe</span>
                            <span class="font-bold">€3.50</span>
                        </button>
                        <button onclick="addToOrder('Erdbeer Crêpe', 4.00)" class="bg-white hover:bg-amber-100 border border-amber-200 text-amber-800 py-2 px-4 rounded-lg transition-all flex justify-between items-center">
                            <span>Erdbeer Crêpe</span>
                            <span class="font-bold">€4.00</span>
                        </button>
                        <button onclick="addToOrder('Zimt-Zucker', 2.50)" class="bg-white hover:bg-amber-100 border border-amber-200 text-amber-800 py-2 px-4 rounded-lg transition-all flex justify-between items-center">
                            <span>Zimt-Zucker</span>
                            <span class="font-bold">€2.50</span>
                        </button>
                        <button onclick="addToOrder('Banane-Nutella', 4.50)" class="bg-white hover:bg-amber-100 border border-amber-200 text-amber-800 py-2 px-4 rounded-lg transition-all flex justify-between items-center">
                            <span>Banane-Nutella</span>
                            <span class="font-bold">€4.50</span>
                        </button>
                    </div>
                </div>
                
                <div class="bg-amber-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-amber-800 mb-4">Aktuelle Bestellung</h3>
                    <div id="currentOrderItems" class="mb-4 max-h-48 overflow-y-auto">
                        <!-- Order items will be added here -->
                    </div>
                    <div class="border-t border-amber-200 pt-2 mb-4">
                        <div class="flex justify-between font-bold text-amber-800">
                            <span>Gesamt:</span>
                            <span id="orderTotal">€0.00</span>
                        </div>
                    </div>
                    <button onclick="placeOrder()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                        Bestellung aufgeben <i class="fas fa-paper-plane ml-2"></i>
                    </button>
                </div>
            </div>
            
            <div class="mt-6 bg-amber-50 p-4 rounded-lg">
                <h3 class="text-lg font-bold text-amber-800 mb-4">Eigene Crêpe erstellen</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-amber-800 mb-1">Basis:</label>
                        <select id="baseSelect" class="w-full px-3 py-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="Weizen">Weizen (€2.00)</option>
                            <option value="Dinkel">Dinkel (€2.50)</option>
                            <option value="Buchweizen">Buchweizen (€3.00)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-amber-800 mb-1">Belag:</label>
                        <select id="toppingSelect" class="w-full px-3 py-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="Nutella">Nutella (€1.50)</option>
                            <option value="Erdbeeren">Erdbeeren (€2.00)</option>
                            <option value="Bananen">Bananen (€1.50)</option>
                            <option value="Zimt-Zucker">Zimt-Zucker (€0.50)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-amber-800 mb-1">Extras:</label>
                        <select id="extraSelect" class="w-full px-3 py-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="Keine">Keine Extras</option>
                            <option value="Schlagsahne">Schlagsahne (€0.80)</option>
                            <option value="Eis">Eis (€1.50)</option>
                            <option value="Nüsse">Nüsse (€1.00)</option>
                        </select>
                    </div>
                </div>
                <button onclick="addCustomCrepe()" class="mt-4 bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                    Zum Warenkorb hinzufügen <i class="fas fa-plus ml-2"></i>
                </button>
            </div>
        </section>

        <!-- Maker Dashboard -->
        <section id="makerSection" class="hidden bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-amber-900">Hersteller Dashboard</h2>
                    <p id="makerStationInfo" class="text-amber-700">Station: <span id="currentStation">1</span></p>
                </div>
                <button onclick="logout()" class="text-amber-800 hover:text-amber-600">
                    <i class="fas fa-sign-out-alt mr-1"></i> Ausloggen
                </button>
            </div>
            
            <div id="currentOrderContainer" class="bg-amber-50 p-4 rounded-lg mb-4">
                <h3 class="text-lg font-bold text-amber-800 mb-4">Aktuelle Bestellung</h3>
                <div id="currentOrderDetails">
                    <p class="text-center text-amber-700 py-8">Keine aktive Bestellung</p>
                </div>
                <div class="flex justify-between mt-4">
                    <button onclick="markOrderAsDone()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                        Fertigstellen <i class="fas fa-check ml-2"></i>
                    </button>
                    <button onclick="skipOrder()" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                        Überspringen <i class="fas fa-forward ml-2"></i>
                    </button>
                </div>
            </div>
            
            <div class="bg-amber-50 p-4 rounded-lg">
                <h3 class="text-lg font-bold text-amber-800 mb-4">Warteschlange</h3>
                <div id="orderQueue" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Orders will be added here -->
                </div>
            </div>
        </section>

        <!-- Owner Dashboard -->
        <section id="ownerSection" class="hidden bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-amber-900">Owner Dashboard</h2>
                <div>
                    <button onclick="logout()" class="text-amber-800 hover:text-amber-600 mr-4">
                        <i class="fas fa-sign-out-alt mr-1"></i> Ausloggen
                    </button>
                    <button onclick="showAddUserModal()" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                        Benutzer hinzufügen <i class="fas fa-plus ml-2"></i>
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-amber-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-amber-800 mb-4">Bestellstatistiken</h3>
                    <canvas id="ordersChart" height="200"></canvas>
                </div>
                <div class="bg-amber-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-amber-800 mb-4">Umsatzstatistiken</h3>
                    <canvas id="revenueChart" height="200"></canvas>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-amber-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-amber-800 mb-4">Aktive Bestellungen</h3>
                    <div id="activeOrders" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Active orders will be added here -->
                    </div>
                </div>
                
                <div class="bg-amber-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-amber-800 mb-4">Benutzerverwaltung</h3>
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-amber-700">Kellner</h4>
                            <button onclick="toggleUserList('waiters')" class="text-amber-800 hover:text-amber-600">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div id="waitersList" class="max-h-0 overflow-hidden transition-all duration-300">
                            <!-- Waiters will be added here -->
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-amber-700">Hersteller</h4>
                            <button onclick="toggleUserList('makers')" class="text-amber-800 hover:text-amber-600">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div id="makersList" class="max-h-0 overflow-hidden transition-all duration-300">
                            <!-- Makers will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Admin Dashboard -->
        <section id="adminSection" class="hidden bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-amber-900">Admin Dashboard</h2>
                <button onclick="logout()" class="text-amber-800 hover:text-amber-600">
                    <i class="fas fa-sign-out-alt mr-1"></i> Ausloggen
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <button onclick="switchToSection('customer')" class="bg-amber-100 hover:bg-amber-200 text-amber-800 font-bold py-4 px-4 rounded-lg transition-all flex flex-col items-center">
                    <i class="fas fa-user text-3xl mb-2"></i>
                    <span>Kundenbereich</span>
                </button>
                <button onclick="switchToSection('waiter')" class="bg-amber-100 hover:bg-amber-200 text-amber-800 font-bold py-4 px-4 rounded-lg transition-all flex flex-col items-center">
                    <i class="fas fa-concierge-bell text-3xl mb-2"></i>
                    <span>Kellner Dashboard</span>
                </button>
                <button onclick="switchToSection('maker')" class="bg-amber-100 hover:bg-amber-200 text-amber-800 font-bold py-4 px-4 rounded-lg transition-all flex flex-col items-center">
                    <i class="fas fa-utensils text-3xl mb-2"></i>
                    <span>Hersteller Dashboard</span>
                </button>
                <button onclick="switchToSection('owner')" class="bg-amber-100 hover:bg-amber-200 text-amber-800 font-bold py-4 px-4 rounded-lg transition-all flex flex-col items-center">
                    <i class="fas fa-user-tie text-3xl mb-2"></i>
                    <span>Owner Dashboard</span>
                </button>
                <button onclick="showAddUserModal()" class="bg-amber-100 hover:bg-amber-200 text-amber-800 font-bold py-4 px-4 rounded-lg transition-all flex flex-col items-center">
                    <i class="fas fa-user-plus text-3xl mb-2"></i>
                    <span>Benutzer hinzufügen</span>
                </button>
                <button onclick="showSystemSettings()" class="bg-amber-100 hover:bg-amber-200 text-amber-800 font-bold py-4 px-4 rounded-lg transition-all flex flex-col items-center">
                    <i class="fas fa-cog text-3xl mb-2"></i>
                    <span>Systemeinstellungen</span>
                </button>
            </div>
            
            <div class="bg-amber-50 p-4 rounded-lg">
                <h3 class="text-lg font-bold text-amber-800 mb-4">Systeminformationen</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-semibold text-amber-700 mb-2">Aktive Benutzer</h4>
                        <div id="activeUsers" class="space-y-2">
                            <!-- Active users will be added here -->
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-amber-700 mb-2">Letzte Aktivitäten</h4>
                        <div id="recentActivities" class="space-y-2">
                            <!-- Recent activities will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Add User Modal -->
        <div id="addUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-amber-900">Benutzer hinzufügen</h3>
                    <button onclick="hideAddUserModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <label for="newUserName" class="block text-amber-800 mb-2">Name:</label>
                    <input type="text" id="newUserName" class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="mb-4">
                    <label for="newUserEmail" class="block text-amber-800 mb-2">E-Mail:</label>
                    <input type="email" id="newUserEmail" class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="mb-4">
                    <label for="newUserPassword" class="block text-amber-800 mb-2">Passwort:</label>
                    <input type="password" id="newUserPassword" class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="mb-6">
                    <label for="newUserRole" class="block text-amber-800 mb-2">Rolle:</label>
                    <select id="newUserRole" class="w-full px-4 py-2 border border-amber-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="waiter">Kellner</option>
                        <option value="maker">Hersteller</option>
                        <option value="owner">Owner</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button onclick="addNewUser()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-all">
                    Benutzer erstellen
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentRole = null;
        let currentStation = null;
        let orders = [];
        let users = [];
        let orderItems = [];
        let totalPrice = 0;
        let ordersChart = null;
        let revenueChart = null;
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Menu toggle
            document.getElementById('menuToggle').addEventListener('click', function() {
                document.getElementById('authMenu').classList.toggle('hidden');
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!document.getElementById('menuToggle').contains(event.target) && 
                    !document.getElementById('authMenu').contains(event.target)) {
                    document.getElementById('authMenu').classList.add('hidden');
                }
            });
            
            // Check if user is already logged in
            checkAuthState();
            
            // Initialize charts (empty for now, will be populated when data is loaded)
            initializeCharts();
            
            // Load initial data
            loadOrders();
            loadUsers();
        });
        
        // Check authentication state
        function checkAuthState() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    // Check user role in database
                    database.ref('users/' + user.uid).once('value').then(snapshot => {
                        const userData = snapshot.val();
                        if (userData) {
                            currentRole = userData.role;
                            if (currentRole === 'maker') {
                                currentStation = userData.station || 1;
                                document.getElementById('currentStation').textContent = currentStation;
                            }
                            showDashboard(currentRole);
                        }
                    });
                } else {
                    // No user is signed in
                    currentUser = null;
                    currentRole = null;
                    showDashboard('customer');
                }
            });
        }
        
        // Show login modal for specific role
        function showLogin(role) {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginTitle').textContent = `${role.charAt(0).toUpperCase() + role.slice(1)} Login`;
            document.getElementById('loginButton').setAttribute('data-role', role);
            
            // Show station selection only for makers
            if (role === 'maker') {
                document.getElementById('makerStationSelection').classList.remove('hidden');
            } else {
                document.getElementById('makerStationSelection').classList.add('hidden');
            }
            
            // Hide auth menu
            document.getElementById('authMenu').classList.add('hidden');
        }
        
        // Hide login modal
        function hideLogin() {
            document.getElementById('loginModal').classList.add('hidden');
        }
        
        // Select maker station
        function selectMakerStation(station) {
            currentStation = station;
            document.getElementById('currentStation').textContent = station;
        }
        
        // Login function
        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const role = document.getElementById('loginButton').getAttribute('data-role');
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Check if user has the correct role
                    return database.ref('users/' + userCredential.user.uid).once('value');
                })
                .then(snapshot => {
                    const userData = snapshot.val();
                    if (userData && userData.role === role) {
                        // If maker, update station if selected
                        if (role === 'maker' && currentStation) {
                            return database.ref('users/' + currentUser.uid).update({
                                station: currentStation
                            });
                        }
                    } else {
                        // Wrong role, sign out
                        auth.signOut();
                        alert('Sie haben keine Berechtigung für diese Rolle.');
                    }
                })
                .then(() => {
                    hideLogin();
                })
                .catch(error => {
                    alert('Login fehlgeschlagen: ' + error.message);
                });
        }
        
        // Logout function
        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                currentRole = null;
                showDashboard('customer');
            }).catch(error => {
                alert('Logout fehlgeschlagen: ' + error.message);
            });
        }
        
        // Show appropriate dashboard based on role
        function showDashboard(role) {
            // Hide all sections first
            document.getElementById('customerSection').classList.add('hidden');
            document.getElementById('waiterSection').classList.add('hidden');
            document.getElementById('makerSection').classList.add('hidden');
            document.getElementById('ownerSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            
            // Show the appropriate section
            if (role === 'customer') {
                document.getElementById('customerSection').classList.remove('hidden');
            } else if (role === 'waiter') {
                document.getElementById('waiterSection').classList.remove('hidden');
                resetOrder();
            } else if (role === 'maker') {
                document.getElementById('makerSection').classList.remove('hidden');
                updateMakerDashboard();
            } else if (role === 'owner') {
                document.getElementById('ownerSection').classList.remove('hidden');
                updateOwnerDashboard();
            } else if (role === 'admin') {
                document.getElementById('adminSection').classList.remove('hidden');
                updateAdminDashboard();
            }
        }
        
        // Switch to specific section (for admin)
        function switchToSection(section) {
            showDashboard(section);
        }
        
        // Check order status for customer
        function checkOrderStatus() {
            const orderNumber = document.getElementById('orderNumber').value;
            if (!orderNumber) {
                alert('Bitte geben Sie eine Bestellnummer ein.');
                return;
            }
            
            // In a real app, this would query the database
            // For demo purposes, we'll simulate a response
            const orderStatus = document.getElementById('orderStatus');
            orderStatus.classList.remove('hidden');
            
            document.getElementById('statusOrderNumber').textContent = '#' + orderNumber;
            
            // Simulate random order details
            const items = ['Nutella Crêpe', 'Erdbeer Crêpe', 'Zimt-Zucker', 'Banane-Nutella'];
            const randomItem = items[Math.floor(Math.random() * items.length)];
            document.getElementById('statusOrderItems').textContent = randomItem;
            
            const queuePosition = Math.floor(Math.random() * 5) + 1;
            document.getElementById('statusQueuePosition').textContent = queuePosition;
            
            const waitTime = queuePosition * 5;
            document.getElementById('statusWaitTime').textContent = waitTime + ' Minuten';
            
            // Show alerts based on wait time
            document.getElementById('readyAlert').classList.add('hidden');
            document.getElementById('almostReadyAlert').classList.add('hidden');
            
            if (waitTime <= 5) {
                if (waitTime <= 0) {
                    document.getElementById('readyAlert').classList.remove('hidden');
                } else {
                    document.getElementById('almostReadyAlert').classList.remove('hidden');
                }
            }
            
            // Add animation
            orderStatus.classList.add('slide-in');
        }
        
        // Waiter functions
        function addToOrder(item, price) {
            orderItems.push({ item, price });
            updateOrderDisplay();
        }
        
        function addCustomCrepe() {
            const base = document.getElementById('baseSelect').value;
            const topping = document.getElementById('toppingSelect').value;
            const extra = document.getElementById('extraSelect').value;
            
            // Calculate price based on selections
            let price = 0;
            if (base.includes('Weizen')) price += 2.00;
            else if (base.includes('Dinkel')) price += 2.50;
            else if (base.includes('Buchweizen')) price += 3.00;
            
            if (topping.includes('Nutella')) price += 1.50;
            else if (topping.includes('Erdbeeren')) price += 2.00;
            else if (topping.includes('Bananen')) price += 1.50;
            else if (topping.includes('Zimt-Zucker')) price += 0.50;
            
            if (extra.includes('Schlagsahne')) price += 0.80;
            else if (extra.includes('Eis')) price += 1.50;
            else if (extra.includes('Nüsse')) price += 1.00;
            
            const itemName = `${base.split(' ')[0]} Crêpe mit ${topping}` + (extra !== 'Keine' ? ` und ${extra}` : '');
            addToOrder(itemName, price);
        }
        
        function updateOrderDisplay() {
            const orderItemsContainer = document.getElementById('currentOrderItems');
            orderItemsContainer.innerHTML = '';
            
            totalPrice = 0;
            
            orderItems.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'flex justify-between items-center mb-2';
                itemElement.innerHTML = `
                    <span class="text-amber-800">${item.item}</span>
                    <div class="flex items-center">
                        <span class="font-bold mr-4">€${item.price.toFixed(2)}</span>
                        <button onclick="removeOrderItem(${index})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                orderItemsContainer.appendChild(itemElement);
                totalPrice += item.price;
            });
            
            document.getElementById('orderTotal').textContent = `€${totalPrice.toFixed(2)}`;
        }
        
        function removeOrderItem(index) {
            orderItems.splice(index, 1);
            updateOrderDisplay();
        }
        
        function resetOrder() {
            orderItems = [];
            totalPrice = 0;
            updateOrderDisplay();
        }
        
        function placeOrder() {
            if (orderItems.length === 0) {
                alert('Bitte fügen Sie Artikel zur Bestellung hinzu.');
                return;
            }
            
            // Generate random order number
            const orderNumber = Math.floor(10000 + Math.random() * 90000);
            
            // Create order object
            const order = {
                id: orderNumber.toString(),
                items: orderItems,
                total: totalPrice,
                status: 'pending',
                timestamp: new Date().getTime(),
                waiterId: currentUser.uid
            };
            
            // Save to database
            database.ref('orders/' + orderNumber).set(order)
                .then(() => {
                    alert(`Bestellung #${orderNumber} erfolgreich aufgegeben!`);
                    resetOrder();
                    loadOrders(); // Refresh orders list
                })
                .catch(error => {
                    alert('Fehler beim Aufgeben der Bestellung: ' + error.message);
                });
        }
        
        // Maker functions
        function updateMakerDashboard() {
            if (currentRole !== 'maker') return;
            
            // Get orders for this station
            database.ref('orders').orderByChild('status').equalTo('pending').once('value')
                .then(snapshot => {
                    const orders = [];
                    snapshot.forEach(childSnapshot => {
                        orders.push(childSnapshot.val());
                    });
                    
                    // Sort by timestamp (oldest first)
                    orders.sort((a, b) => a.timestamp - b.timestamp);
                    
                    // Display current order (first in queue)
                    const currentOrderContainer = document.getElementById('currentOrderDetails');
                    const orderQueueContainer = document.getElementById('orderQueue');
                    
                    currentOrderContainer.innerHTML = '';
                    orderQueueContainer.innerHTML = '';
                    
                    if (orders.length > 0) {
                        const currentOrder = orders[0];
                        displayOrderDetails(currentOrderContainer, currentOrder, true);
                        
                        // Display queue (remaining orders)
                        for (let i = 1; i < orders.length; i++) {
                            const orderElement = document.createElement('div');
                            orderElement.className = 'bg-white p-3 rounded-lg border border-amber-200';
                            displayOrderDetails(orderElement, orders[i], false);
                            orderQueueContainer.appendChild(orderElement);
                        }
                    } else {
                        currentOrderContainer.innerHTML = '<p class="text-center text-amber-700 py-8">Keine aktive Bestellung</p>';
                    }
                });
        }
        
        function displayOrderDetails(container, order, isCurrent) {
            container.innerHTML = `
                <div class="mb-2">
                    <span class="text-amber-700">Bestellnummer:</span>
                    <span class="font-bold">#${order.id}</span>
                </div>
                <div class="mb-2">
                    <span class="text-amber-700">Bestellung:</span>
                    <ul class="list-disc list-inside ml-2">
                        ${order.items.map(item => `<li>${item.item} (€${item.price.toFixed(2)})</li>`).join('')}
                    </ul>
                </div>
                <div class="mb-2">
                    <span class="text-amber-700">Gesamtpreis:</span>
                    <span class="font-bold">€${order.total.toFixed(2)}</span>
                </div>
                ${isCurrent ? `
                <div class="mt-4 text-sm text-amber-700">
                    <i class="fas fa-clock mr-1"></i> ${new Date(order.timestamp).toLocaleTimeString()}
                </div>
                ` : ''}
            `;
        }
        
        function markOrderAsDone() {
            // Get the current order (first in queue)
            database.ref('orders').orderByChild('status').equalTo('pending').once('value')
                .then(snapshot => {
                    const orders = [];
                    snapshot.forEach(childSnapshot => {
                        orders.push({ id: childSnapshot.key, ...childSnapshot.val() });
                    });
                    
                    if (orders.length > 0) {
                        const currentOrder = orders[0];
                        
                        // Update order status to 'done'
                        return database.ref('orders/' + currentOrder.id).update({
                            status: 'done',
                            makerId: currentUser.uid,
                            completedAt: new Date().getTime()
                        });
                    }
                })
                .then(() => {
                    updateMakerDashboard();
                    loadOrders(); // Refresh orders list for owner
                })
                .catch(error => {
                    alert('Fehler beim Markieren der Bestellung: ' + error.message);
                });
        }
        
        function skipOrder() {
            // Get the current order (first in queue)
            database.ref('orders').orderByChild('status').equalTo('pending').once('value')
                .then(snapshot => {
                    const orders = [];
                    snapshot.forEach(childSnapshot => {
                        orders.push({ id: childSnapshot.key, ...childSnapshot.val() });
                    });
                    
                    if (orders.length > 0) {
                        const currentOrder = orders[0];
                        
                        // Move to end of queue by updating timestamp
                        return database.ref('orders/' + currentOrder.id).update({
                            timestamp: new Date().getTime()
                        });
                    }
                })
                .then(() => {
                    updateMakerDashboard();
                })
                .catch(error => {
                    alert('Fehler beim Überspringen der Bestellung: ' + error.message);
                });
        }
        
        // Owner functions
        function updateOwnerDashboard() {
            if (currentRole !== 'owner' && currentRole !== 'admin') return;
            
            // Update active orders
            database.ref('orders').orderByChild('status').equalTo('pending').once('value')
                .then(snapshot => {
                    const activeOrdersContainer = document.getElementById('activeOrders');
                    activeOrdersContainer.innerHTML = '';
                    
                    const orders = [];
                    snapshot.forEach(childSnapshot => {
                        orders.push(childSnapshot.val());
                    });
                    
                    // Sort by timestamp (oldest first)
                    orders.sort((a, b) => a.timestamp - b.timestamp);
                    
                    if (orders.length > 0) {
                        orders.forEach(order => {
                            const orderElement = document.createElement('div');
                            orderElement.className = 'bg-white p-3 rounded-lg border border-amber-200';
                            orderElement.innerHTML = `
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold">#${order.id}</span>
                                    <span class="text-sm text-amber-700">${new Date(order.timestamp).toLocaleTimeString()}</span>
                                </div>
                                <div class="text-sm text-amber-800">
                                    ${order.items.length} Artikel - €${order.total.toFixed(2)}
                                </div>
                            `;
                            activeOrdersContainer.appendChild(orderElement);
                        });
                    } else {
                        activeOrdersContainer.innerHTML = '<p class="text-center text-amber-700 py-4">Keine aktive Bestellungen</p>';
                    }
                });
            
            // Update charts
            updateCharts();
        }
        
        function initializeCharts() {
            const ordersCtx = document.getElementById('ordersChart').getContext('2d');
            ordersChart = new Chart(ordersCtx, {
                type: 'bar',
                data: {
                    labels: ['Heute', 'Gestern', 'Vorgestern'],
                    datasets: [{
                        label: 'Bestellungen',
                        data: [0, 0, 0],
                        backgroundColor: 'rgba(245, 158, 11, 0.6)',
                        borderColor: 'rgba(245, 158, 11, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun'],
                    datasets: [{
                        label: 'Umsatz (€)',
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        borderColor: 'rgba(245, 158, 11, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function updateCharts() {
            // In a real app, this would fetch actual data from the database
            // For demo purposes, we'll use random data
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const dayBefore = new Date(today);
            dayBefore.setDate(dayBefore.getDate() - 2);
            
            ordersChart.data.labels = [
                today.toLocaleDateString(),
                yesterday.toLocaleDateString(),
                dayBefore.toLocaleDateString()
            ];
            
            ordersChart.data.datasets[0].data = [
                Math.floor(Math.random() * 20) + 10,
                Math.floor(Math.random() * 20) + 10,
                Math.floor(Math.random() * 20) + 10
            ];
            
            revenueChart.data.datasets[0].data = [
                Math.floor(Math.random() * 500) + 200,
                Math.floor(Math.random() * 500) + 200,
                Math.floor(Math.random() * 500) + 200,
                Math.floor(Math.random() * 500) + 200,
                Math.floor(Math.random() * 500) + 200,
                Math.floor(Math.random() * 500) + 200
            ];
            
            ordersChart.update();
            revenueChart.update();
        }
        
        function toggleUserList(type) {
            const listElement = document.getElementById(`${type}List`);
            listElement.classList.toggle('max-h-0');
            listElement.classList.toggle('max-h-screen');
        }
        
        function showAddUserModal() {
            document.getElementById('addUserModal').classList.remove('hidden');
        }
        
        function hideAddUserModal() {
            document.getElementById('addUserModal').classList.add('hidden');
        }
        
        function addNewUser() {
            const name = document.getElementById('newUserName').value;
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            if (!name || !email || !password) {
                alert('Bitte füllen Sie alle Felder aus.');
                return;
            }
            
            // Create user in Firebase Auth
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Save additional user data to database
                    return database.ref('users/' + userCredential.user.uid).set({
                        name: name,
                        email: email,
                        role: role,
                        createdAt: new Date().getTime()
                    });
                })
                .then(() => {
                    alert('Benutzer erfolgreich erstellt!');
                    hideAddUserModal();
                    loadUsers(); // Refresh users list
                })
                .catch(error => {
                    alert('Fehler beim Erstellen des Benutzers: ' + error.message);
                });
        }
        
        // Admin functions
        function updateAdminDashboard() {
            if (currentRole !== 'admin') return;
            
            // Load active users
            database.ref('users').once('value')
                .then(snapshot => {
                    const activeUsersContainer = document.getElementById('activeUsers');
                    activeUsersContainer.innerHTML = '';
                    
                    snapshot.forEach(childSnapshot => {
                        const user = childSnapshot.val();
                        const userElement = document.createElement('div');
                        userElement.className = 'bg-white p-2 rounded-lg border border-amber-200';
                        userElement.innerHTML = `
                            <div class="flex justify-between items-center">
                                <span class="font-semibold">${user.name}</span>
                                <span class="text-xs px-2 py-1 rounded ${getRoleColor(user.role)}">${user.role}</span>
                            </div>
                            <div class="text-xs text-amber-700">${user.email}</div>
                        `;
                        activeUsersContainer.appendChild(userElement);
                    });
                });
            
            // Load recent activities (simulated)
            const activitiesContainer = document.getElementById('recentActivities');
            activitiesContainer.innerHTML = '';
            
            const activities = [
                { action: 'Bestellung aufgegeben', user: 'Max Mustermann', time: 'vor 2 Minuten' },
                { action: 'Bestellung fertiggestellt', user: 'Erika Musterfrau', time: 'vor 5 Minuten' },
                { action: 'Neuer Benutzer erstellt', user: 'Admin', time: 'vor 15 Minuten' },
                { action: 'Systemaktualisierung', user: 'System', time: 'vor 1 Stunde' }
            ];
            
            activities.forEach(activity => {
                const activityElement = document.createElement('div');
                activityElement.className = 'bg-white p-2 rounded-lg border border-amber-200';
                activityElement.innerHTML = `
                    <div class="text-sm font-semibold">${activity.action}</div>
                    <div class="flex justify-between text-xs text-amber-700">
                        <span>${activity.user}</span>
                        <span>${activity.time}</span>
                    </div>
                `;
                activitiesContainer.appendChild(activityElement);
            });
        }
        
        function getRoleColor(role) {
            switch(role) {
                case 'admin': return 'bg-purple-100 text-purple-800';
                case 'owner': return 'bg-blue-100 text-blue-800';
                case 'waiter': return 'bg-green-100 text-green-800';
                case 'maker': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        function showSystemSettings() {
            alert('Systemeinstellungen werden hier angezeigt. (Demo)');
        }
        
        // Load orders from database
        function loadOrders() {
            database.ref('orders').on('value', snapshot => {
                orders = [];
                snapshot.forEach(childSnapshot => {
                    orders.push(childSnapshot.val());
                });
                
                // Update relevant dashboards
                if (currentRole === 'maker') updateMakerDashboard();
                if (currentRole === 'owner' || currentRole === 'admin') updateOwnerDashboard();
            });
        }
        
        // Load users from database
        function loadUsers() {
            database.ref('users').once('value')
                .then(snapshot => {
                    users = [];
                    snapshot.forEach(childSnapshot => {
                        users.push({ id: childSnapshot.key, ...childSnapshot.val() });
                    });
                    
                    // Update waiters and makers lists
                    updateUserLists();
                });
        }
        
        function updateUserLists() {
            const waiters = users.filter(user => user.role === 'waiter');
            const makers = users.filter(user => user.role === 'maker');
            
            const waitersList = document.getElementById('waitersList');
            waitersList.innerHTML = '';
            
            const makersList = document.getElementById('makersList');
            makersList.innerHTML = '';
            
            waiters.forEach(waiter => {
                const waiterElement = document.createElement('div');
                waiterElement.className = 'flex justify-between items-center p-2 bg-white rounded mb-1';
                waiterElement.innerHTML = `
                    <span>${waiter.name}</span>
                    <button onclick="deleteUser('${waiter.id}')" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                waitersList.appendChild(waiterElement);
            });
            
            makers.forEach(maker => {
                const makerElement = document.createElement('div');
                makerElement.className = 'flex justify-between items-center p-2 bg-white rounded mb-1';
                makerElement.innerHTML = `
                    <span>${maker.name} (Station ${maker.station || 'N/A'})</span>
                    <button onclick="deleteUser('${maker.id}')" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                makersList.appendChild(makerElement);
            });
        }
        
        function deleteUser(userId) {
            if (confirm('Sind Sie sicher, dass Sie diesen Benutzer löschen möchten?')) {
                // Delete from authentication
                auth.getUser(userId)
                    .then(() => {
                        return auth.deleteUser(userId);
                    })
                    .then(() => {
                        // Delete from database
                        return database.ref('users/' + userId).remove();
                    })
                    .then(() => {
                        alert('Benutzer erfolgreich gelöscht.');
                        loadUsers(); // Refresh list
                    })
                    .catch(error => {
                        alert('Fehler beim Löschen des Benutzers: ' + error.message);
                    });
            }
        }
    </script>
</body>
</html>
